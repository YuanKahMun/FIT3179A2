{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "autosize": { "type": "fit", "contains": "padding" },
  "params": [
    { "name": "StageSel", "value": "primary" },
    { "name": "YearSel",  "value": 2022 },
    { "name": "StateSel", "value": "Johor" },
    { "name": "Zoom",     "value": 3000 },
    { "name": "CenterTo", "value": [109.3, 4.2] }
  ],
  "width": 1400, 
  "height": 520,
  "projection": {
    "type":"mercator",
    "center":{"expr":"CenterTo"},
    "scale":{"expr":"Zoom"},
    "translate":[680,170]
  },
  "layer": [
    {
      "data": { "graticule": { "step": [3, 3] } },
      "mark": { "type": "geoshape", "fill": null, "stroke": "#d9d9d9", "strokeWidth": 0.5, "opacity": 0.8 }
    },
    {
      "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/malaysia_states.topojson", "format": { "type": "topojson", "feature": "states" } },
      "mark": { "type": "geoshape", "fill": "#f2f2f2", "stroke": "white", "strokeWidth": 0.5 }
    },
    {
      "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/compiled_my_basiced_districtenrolment.csv" },
      "transform": [
        { "filter": "datum.stage == StageSel" },
        { "filter": "datum.year == YearSel" },
        { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" },
        {
          "lookup": "state_norm",
          "from": {
            "data": { "url": "/data/malaysia_states.topojson", "format": { "type": "topojson", "feature": "states" } },
            "key": "properties.name",
            "fields": ["type","properties","geometry"]
          }
        }
      ],
      "mark": { "type": "geoshape", "stroke": "white", "strokeWidth": 0.5 },
      "encoding": {
        "color": {
          "field": "students_per_1000_pop",
          "type": "quantitative",
          "title": "Students per 1,000 population",
          "scale": {
            "type": "quantize",
            "scheme": {
              "expr": "StageSel === 'primary' ? 'blues' : 'yelloworangebrown'",
              "count": 5
            }
          }
        },
        "tooltip": [
          { "field": "state_norm", "title": "State" },
          { "field": "stage", "title": "Stage" },
          { "field": "year",  "title": "Year" },
          { "field": "students_per_1000_pop", "title": "Per 1000", "format": ".1f" },
          { "field": "students_per_school", "title": "Per school", "format": ".1f" },
          { "field": "students", "title": "Students", "format": "," },
          { "field": "schools",  "title": "Schools",  "format": "," }
        ]
      }
    },
    {
      "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/compiled_my_basiced_districtenrolment.csv" },
      "transform": [
        { "filter": "datum.stage == StageSel" },
        { "filter": "datum.year == YearSel" },
        { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" },
        { "calculate": "toNumber(datum.students_per_1000_pop)", "as": "rate" },
        { "calculate": "toNumber(datum.lat)", "as": "lat_n" },
        { "calculate": "toNumber(datum.lng)", "as": "lng_n" },
        { "window": [{ "op": "rank", "as": "r" }], "sort": [{ "field": "rate", "order": "descending" }] },
        { "filter": "datum.r <= 3" },
        {
          "calculate": "datum.state_norm == 'Perlis' ? datum.lng_n - 2.5 : datum.state_norm == 'Kedah' ? datum.lng_n - 2.8 : datum.state_norm == 'Penang' ? datum.lng_n - 3 : datum.state_norm == 'Perak' ? datum.lng_n - 3 : datum.state_norm == 'Selangor' ? datum.lng_n - 3.2 : datum.state_norm == 'Kuala Lumpur' ? datum.lng_n - 3.5 : datum.state_norm == 'Putrajaya' ? datum.lng_n - 3.5 : datum.state_norm == 'Negeri Sembilan' ? datum.lng_n - 3.8 : datum.state_norm == 'Melaka' ? datum.lng_n - 3.8 : datum.state_norm == 'Johor' ? datum.lng_n + 4 : datum.state_norm == 'Pahang' ? datum.lng_n + 5 : datum.state_norm == 'Terengganu' ? datum.lng_n + 4.5 : datum.state_norm == 'Kelantan' ? datum.lng_n + 5 : datum.lng_n + 4",
          "as": "label_lng"
        },
        {
          "calculate": "datum.state_norm == 'Perlis' ? datum.lat_n + 0.5 : datum.state_norm == 'Kedah' ? datum.lat_n : datum.state_norm == 'Penang' ? datum.lat_n - 0.5 : datum.state_norm == 'Perak' ? datum.lat_n : datum.state_norm == 'Selangor' ? datum.lat_n : datum.state_norm == 'Kuala Lumpur' ? datum.lat_n - 0.8 : datum.state_norm == 'Putrajaya' ? datum.lat_n - 1.2 : datum.state_norm == 'Negeri Sembilan' ? datum.lat_n - 1.6 : datum.state_norm == 'Melaka' ? datum.lat_n - 2 : datum.state_norm == 'Johor' ? datum.lat_n : datum.state_norm == 'Pahang' ? datum.lat_n : datum.state_norm == 'Terengganu' ? datum.lat_n + 0.5 : datum.state_norm == 'Kelantan' ? datum.lat_n : datum.lat_n",
          "as": "label_lat"
        }
      ],
      "layer": [
        {
          "mark": { 
            "type": "rule",
            "strokeWidth": 1,
            "color": "#666",
            "strokeDash": [2, 2]
          },
          "encoding": {
            "longitude": { "field": "lng_n" },
            "latitude": { "field": "lat_n" },
            "longitude2": { "field": "label_lng" },
            "latitude2": { "field": "label_lat" }
          }
        },
        {
          "mark": { 
            "type": "text", 
            "fontSize": 11, 
            "fontWeight": "bold",
            "font": "DM Sans"
          },
          "encoding": {
            "longitude": { "field": "label_lng" },
            "latitude": { "field": "label_lat" },
            "text": { "field": "state_norm", "type": "nominal" },
            "color": { "value": "#000" }
          }
        }
      ]
    }
  ],
  "title": { 
    "text": "Basic Education Access on students per 1000 population by stage in Malaysia", 
    "subtitle": "Filter by Selected Stage & Year",
    "anchor": "middle"
  },
  "config": {
    "font": "PT Serif",
    "title": { 
      "font": "PT Serif", 
      "fontSize": 20, 
      "fontWeight": 700,
      "subtitleFont": "PT Serif", 
      "subtitleFontSize": 16,   
      "subtitlePadding": 16,
      "offset": 50
    },
    "axis": { 
      "labelFont": "DM Sans", 
      "titleFont": "PT Serif", 
      "titleFontWeight": 700 
    },
    "legend": { 
      "labelFont": "DM Sans", 
      "titleFont": "PT Serif", 
      "titleFontWeight": 700 
    },
    "header": { 
      "labelFont": "DM Sans", 
      "titleFont": "PT Serif", 
      "titleFontWeight": 700 
    },
    "view": { "stroke": null }
  }
}