{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "autosize": { "type": "fit", "contains": "padding" },
  "params": [
    { "name": "StageSel", "value": "primary" },
    { "name": "YearSel",  "value": 2022 },
    { "name": "StateSel", "value": "Johor" }
  ],
  "title": { 
    "text": "Population vs Students Comparison",
    "anchor": "middle"
  },
  "data": { 
    "url": "./data/compiled_my_basiced_districtenrolment.csv" 
  },
  "transform": [
    { 
      "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", 
      "as": "state_norm" 
    },
    {
      "aggregate": [
        { "op": "mean", "field": "population", "as": "sum_population" },
        { "op": "sum", "field": "students", "as": "sum_students" }
      ],
      "groupby": ["state_norm"]
    },
    { 
      "calculate": "datum.sum_students / max(datum.sum_population, 1)", 
      "as": "stud_pop_ratio" 
    },
    { 
      "fold": ["sum_population", "sum_students"], 
      "as": ["metric_key", "count"] 
    },
    { 
      "calculate": "datum.metric_key == 'sum_population' ? 'Population' : 'Students'", 
      "as": "metric_label" 
    },
    { 
      "joinaggregate": [{ "op": "max", "field": "count", "as": "max_count" }], 
      "groupby": ["metric_label"] 
    },
    { 
      "calculate": "datum.count == datum.max_count", 
      "as": "is_max" 
    }
  ],
  "columns": 2,
  "facet": {
    "column": {
      "field": "metric_label", 
      "type": "nominal", 
      "title": null, 
      "sort": ["Population","Students"],
      "header": { 
        "labelExpr": "datum.label == 'Population' ? 'Population (total)' : 'Students (total)'" 
      }
    }
  },
  "spec": {
    "layer": [
      {
        "mark": { "type": "bar" },
        "encoding": {
          "y": { 
            "field": "state_norm", 
            "type": "nominal",
            "sort": { "field": "stud_pop_ratio", "order": "descending" },
            "title": "States & Federal Territories", 
            "axis": { "labelLimit": 180 } 
          },
          "x": { 
            "field": "count", 
            "type": "quantitative", 
            "title": "Total", 
            "axis": { "format": "s" } 
          },
          "color": { 
            "field": "metric_label", 
            "type": "nominal", 
            "legend": null,
            "scale": { 
              "domain": ["Population","Students"], 
              "range": ["#4e79a7","#f28e2b"] 
            } 
          },
          "opacity": { 
            "condition": { "test": "datum.is_max", "value": 1 }, 
            "value": 0.3 
          },
          "stroke": { "value": "black" },
          "strokeWidth": { 
            "condition": { "test": "datum.is_max", "value": 1.5 }, 
            "value": 0 
          },
          "tooltip": [
            { "field": "state_norm", "title": "State" },
            { 
              "field": "sum_population", 
              "title": "Population (total)", 
              "format": "," 
            },
            { 
              "field": "sum_students", 
              "title": "Students (total)", 
              "format": "," 
            },
            { 
              "field": "stud_pop_ratio", 
              "title": "Students per person", 
              "format": ".3f" 
            }
          ]
        }
      },
      {
        "transform": [{ "filter": "datum.is_max" }],
        "mark": { 
          "type": "text", 
          "dx": 6, 
          "align": "left", 
          "fontWeight": "bold" 
        },
        "encoding": {
          "y": { "field": "state_norm", "type": "nominal" },
          "x": { "field": "count", "type": "quantitative" },
          "text": { 
            "field": "count", 
            "type": "quantitative", 
            "format": "s" 
          },
          "color": { "value": "#333" }
        }
      }
    ],
    "width": 580,
    "height": { "step": 40 }
  },
  "resolve": { "scale": { "x": "independent" } },
  "config": {
    "font": "PT Serif",
    "title": { 
      "font": "PT Serif", 
      "fontSize": 20, 
      "fontWeight": 700,
      "subtitleFont": "PT Serif", 
      "subtitleFontSize": 16,   
      "subtitlePadding": 16,
      "offset": 50
    },
    "axis": { 
      "labelFont": "DM Sans", 
      "titleFont": "PT Serif", 
      "titleFontWeight": 700 
    },
    "legend": { 
      "labelFont": "DM Sans", 
      "titleFont": "PT Serif", 
      "titleFontWeight": 700 
    },
    "header": { 
      "labelFont": "DM Sans", 
      "titleFont": "PT Serif", 
      "titleFontWeight": 700 
    },
    "view": { "stroke": null }
  }
}