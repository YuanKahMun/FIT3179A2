{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "autosize": { "type": "fit", "contains": "padding" },
  "params": [
    { "name": "StageSel", "value": "primary" },
    { "name": "YearSel",  "value": 2022 },
    { "name": "StateSel", "value": "Johor" }
  ],
  "width": 1400,
  "height": { "step": 40 },
  "title": { 
    "text": "Basic Education stage gap on students per 1000 population within each state", 
    "subtitle": "Filter by Selected Year" 
  },
  "data": { 
    "url": "https://yuankahmun.github.io/FIT3179A2/data/compiled_my_basiced_districtenrolment.csv" 
  },
  "transform": [
    { "filter": "datum.year == YearSel" },
    { 
      "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", 
      "as": "state_norm" 
    }
  ],
  "layer": [
    {
      "transform": [
        { 
          "aggregate": [
            { "op": "min", "field": "students_per_1000_pop", "as": "xMin" },
            { "op": "max", "field": "students_per_1000_pop", "as": "xMax" }
          ],
          "groupby": ["state_norm"]
        }
      ],
      "mark": { "type": "rule" },
      "encoding": {
        "y": { 
          "field": "state_norm", 
          "type": "nominal",
          "sort": {"field":"students_per_1000_pop","op":"max","order":"descending"} 
        },
        "x": { 
          "field": "xMin", 
          "type": "quantitative", 
          "title": "Students per 1000 population" 
        },
        "x2": { "field": "xMax" }
      }
    },
    {
      "mark": { "type": "point", "filled": true, "size": 60 },
      "encoding": {
        "y": { 
          "field": "state_norm", 
          "type": "nominal",
          "title": "States & Federal Territories",
          "sort": {"field":"students_per_1000_pop","op":"max","order":"descending"} 
        },
        "x": { "field": "students_per_1000_pop", "type": "quantitative" },
        "color": {
          "field": "stage", 
          "type": "nominal", 
          "title": "Stage",
          "scale": { "domain": ["primary","secondary"], "range": ["#4e79a7","#f28e2b"] }
        },
        "tooltip": [
          { "field": "state_norm", "title": "State" },
          { "field": "stage", "title": "Stage" },
          { "field": "students_per_1000_pop", "title": "Per 1000", "format": ".1f" }
        ]
      }
    },
    {
      "transform": [
        { 
          "aggregate": [ 
            { "op": "mean", "field": "students_per_1000_pop", "as": "rate" } 
          ],
          "groupby": ["state_norm","stage"] 
        },
        { 
          "pivot": "stage", 
          "value": "rate", 
          "groupby": ["state_norm"] 
        },
        { 
          "calculate": "datum.secondary - datum.primary", 
          "as": "diff" 
        },
        { 
          "calculate": "(datum.secondary + datum.primary)/2", 
          "as": "midX" 
        }
      ],
      "mark": { "type": "text", "fontWeight": "bold", "dy": -6 },
      "encoding": {
        "y": { 
          "field": "state_norm", 
          "type": "nominal",
          "sort": {"field":"students_per_1000_pop","op":"max","order":"descending"} 
        },
        "x": { "field": "midX", "type": "quantitative" },
        "text": { "field": "diff", "type": "quantitative", "format": "+,.1f" },
        "color": { "value": "#000" }
      }
    }
  ],
  "config": {
    "font": "PT Serif",
    "title": { 
      "font": "PT Serif", 
      "fontSize": 20, 
      "fontWeight": 700,
      "subtitleFont": "PT Serif", 
      "subtitleFontSize": 16,   
      "subtitlePadding": 16,
      "offset": 50
    },
    "axis": { 
      "labelFont": "DM Sans", 
      "titleFont": "PT Serif", 
      "titleFontWeight": 700 
    },
    "legend": { 
      "labelFont": "DM Sans", 
      "titleFont": "PT Serif", 
      "titleFontWeight": 700 
    },
    "header": { 
      "labelFont": "DM Sans", 
      "titleFont": "PT Serif", 
      "titleFontWeight": 700 
    },
    "view": { "stroke": null }
  }
}