{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": { "text": "Stage gap within each state — Primary vs Secondary students per 1,000", "subtitle": "Difference between stages · Selected Year" },
  "data": { "url": "../data/compiled_my_basiced_districtenrolment.csv" },

  "params": [
    { "name": "YearSel", "value": 2022, "bind": { "input": "select", "options": [2017,2018,2019,2020,2021,2022], "name": " Year: " } }
  ],

  "transform": [
    { "filter": "datum.year == YearSel" },
    { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" }
  ],

  "layer": [
    {
      "transform": [
        { "aggregate": [
            { "op": "min", "field": "students_per_1000_pop", "as": "xMin" },
            { "op": "max", "field": "students_per_1000_pop", "as": "xMax" }
          ],
          "groupby": ["state_norm"]
        }
      ],
      "mark": { "type": "rule" },
      "encoding": {
        "y": { "field": "state_norm", "type": "nominal", "sort": "-x" },
        "x": { "field": "xMin", "type": "quantitative", "title": "Students per 1,000 population" },
        "x2": { "field": "xMax" }
      }
    },
    {
      "mark": { "type": "point", "filled": true, "size": 60 },
      "encoding": {
        "y": { "field": "state_norm", "type": "nominal", "title": "States & Federal Territories", "sort": "-x" },
        "x": { "field": "students_per_1000_pop", "type": "quantitative" },
        "color": {
          "field": "stage", "type": "nominal", "title": "Stage",
          "scale": { "domain": ["primary","secondary"], "range": ["#4e79a7","#f28e2b"] }
        },
        "tooltip": [
          { "field": "state_norm", "title": "State" },
          { "field": "stage", "title": "Stage" },
          { "field": "students_per_1000_pop", "title": "Per 1,000", "format": ".1f" }
        ]
      }
    },
    {
      "transform": [
        { "aggregate": [ { "op": "mean", "field": "students_per_1000_pop", "as": "rate" } ],
          "groupby": ["state_norm","stage"] },
        { "pivot": "stage", "value": "rate", "groupby": ["state_norm"] },
        { "calculate": "datum.secondary - datum.primary", "as": "diff" },
        { "calculate": "(datum.secondary + datum.primary)/2", "as": "midX" }
      ],
      "mark": { "type": "text", "fontWeight": "bold", "dy": -6 },
      "encoding": {
        "y": { "field": "state_norm", "type": "nominal" },
        "x": { "field": "midX", "type": "quantitative" },
        "text": { "field": "diff", "type": "quantitative", "format": "+,.1f" },
        "color": {
          "value": "#000"                                              
        }
      }
    }

  ],

  "height": { "step": 20 },
  "width": 720,
  "config": { "view": { "stroke": null } }
}
