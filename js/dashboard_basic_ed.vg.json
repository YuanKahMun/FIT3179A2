{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",


  "autosize": { "type": "fit", "contains": "padding" },



  

  "params": [
    { "name": "StageSel", "value": "primary" },
    { "name": "YearSel",  "value": 2022 },
    { "name": "StateSel", "value": "Johor" },
    { "name": "Rekey", "value": 0 },

    { "name": "Zoom",     "value": 2250 },
    { "name": "CenterTo", "value": [109.3, 4.2] }

    ],


    

   


  "vconcat": [


    {
      "title": { "text": "Basic Education Access on students per 1000 population by stage in Malaysia", "subtitle": "Filter by Selected Stage & Year" },
      "width": 1100, "height": 520,
      "projection": {
        "type":"mercator",
        "center":{"expr":"CenterTo"},
        "scale":{"expr":"Zoom"},
        "translate":[420,260]
      },

      "layer": [
        {
          "data": { "graticule": { "step": [3, 3] } },
          "mark": { "type": "geoshape", "fill": null, "stroke": "#d9d9d9", "strokeWidth": 0.5, "opacity": 0.8 }
        },
        {
          "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/malaysia_states.topojson", "format": { "type": "topojson", "feature": "states" } },
          "mark": { "type": "geoshape", "fill": "#f2f2f2", "stroke": "white", "strokeWidth": 0.5 }
        },
        {
          "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/compiled_my_basiced_districtenrolment.csv" },
          "transform": [
            { "filter": "datum.stage == StageSel" },
            { "filter": "datum.year == YearSel" },
            
            { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" },
            {
              "lookup": "state_norm",
              "from": {
                "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/malaysia_states.topojson", "format": { "type": "topojson", "feature": "states" } },
                "key": "properties.name",
                "fields": ["type","properties","geometry"]
              }
            }
          ],
          "mark": { "type": "geoshape", "stroke": "white", "strokeWidth": 0.5 },
          "encoding": {

            "color": {
                "field": "students_per_1000_pop",
                "type": "quantitative",
                "title": "Students per 1,000 population",
                "scale": {
                    "type": "quantize",
                    "domain": [0, 800],
                    "scheme": {
                    "expr": "StageSel === 'primary' ? 'blues' : 'oranges'",
                    "count": 5
                    }
                }
                },

            "tooltip": [
              { "field": "state_norm", "title": "State" },
              { "field": "stage", "title": "Stage" },
              { "field": "year",  "title": "Year" },
              { "field": "students_per_1000_pop", "title": "Per 1000", "format": ".1f" },
              { "field": "students_per_school", "title": "Per school", "format": ".1f" },
              { "field": "students", "title": "Students", "format": "," },
              { "field": "schools",  "title": "Schools",  "format": "," }
            ]
          }
        },
        {
          "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/compiled_my_basiced_districtenrolment.csv" },
          "transform": [
            { "filter": "datum.stage == StageSel" },
            { "filter": "datum.year == YearSel" },
            { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" },
            { "calculate": "toNumber(datum.students_per_1000_pop)", "as": "rate" },
            { "calculate": "toNumber(datum.lat)", "as": "lat_n" },
            { "calculate": "toNumber(datum.lng)", "as": "lng_n" },
            { "window": [{ "op": "rank", "as": "r" }], "sort": [{ "field": "rate", "order": "descending" }] },
            { "calculate": "datum.state_norm", "as": "label" },
            { "filter": "datum.r <= 5" }
          ],
          "mark": { "type": "text", "fontSize": 10, "fontWeight": "bold", "dx": 6, "dy": -6 },
          "encoding": {
            "longitude": { "field": "lng_n" },
            "latitude":  { "field": "lat_n" },
            "text": { "field": "label", "type": "nominal" },
            "tooltip": [
              { "field": "r", "title": "Rank" },
              { "field": "state_norm", "title": "State" },
              { "field": "rate", "title": "Per 1000", "format": ".1f" }
            ]
          }
        }
        
      ]
    },

    {
  "hconcat": [
    {
      "title": {
        "text": "Average number of students per school within each state by stage",
        "subtitle": " Filter by Selected Year"
      },
      "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/compiled_my_basiced_districtenrolment.csv" },
      "transform": [
        { "filter": "datum.year == YearSel" },
        {
          "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state",
          "as": "state_norm"
        }
      ],
      "mark": { "type": "bar" },
      "encoding": {
        "y": {
          "field": "state_norm",
          "type": "nominal",
          "title": "States & Federal Territories",
          "sort": { "op": "mean", "field": "students_per_school", "order": "descending" },
          "axis": { "labelLimit": 180, "labelPadding": 4 }
        },
        "yOffset": { "field": "stage" },
        "x": {
          "aggregate": "mean",
          "field": "students_per_school",
          "type": "quantitative",
          "title": "Students per school (mean)"
        },
        "color": {
          "field": "stage",
          "type": "nominal",
          "title": "Stage",
          "scale": { "domain": ["primary", "secondary"], "range": ["#4e79a7", "#f28e2b"] }
        },
        "tooltip": [
          { "field": "state_norm", "title": "State" },
          { "field": "stage", "title": "Stage" },
          { "aggregate": "mean", "field": "students_per_school", "title": "Per school (mean)", "format": ".1f" },
          { "field": "schools", "title": "Schools" },
          { "field": "students", "title": "Students" }
        ]
      },
      "width": 480,
      "height": { "step": 20 }
    },

    {
      "title": {
        "text": "Crowding deviation on students per school vs national median",
        "subtitle": "Filter by Selected Stage & Year Â· Positive = more crowded than median"
      },
      "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/compiled_my_basiced_districtenrolment.csv" },
      "transform": [
        { "filter": "datum.stage == StageSel && datum.year == YearSel" },
        { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" },
        { "joinaggregate": [{ "op": "median", "field": "students_per_school", "as": "med_sps" }] },
        { "calculate": "datum.students_per_school - datum.med_sps", "as": "dev" }
      ],
      "layer": [
        {
          "mark": { "type": "point", "filled": true, "size": 70, "opacity": 0.9 },
          "encoding": {
            "y": {
              "field": "state_norm",
              "type": "nominal",
              "title": "States & Federal Territories",
              "sort": { "field": "dev", "order": "descending" },
              "axis": { "labelLimit": 180 }
            },
            "x": {
              "field": "dev",
              "type": "quantitative",
              "title": "Deviation from national median (students per school)"
            },
            "color": {
              "field": "stage",
              "type": "nominal",
              "legend": null,
              "scale": { "domain": ["primary","secondary"], "range": ["#4e79a7","#f28e2b"] }
            },
            "tooltip": [
              { "field": "state_norm", "title": "State" },
              { "field": "stage", "title": "Stage" },
              { "field": "year", "title": "Year" },
              { "field": "students_per_school", "title": "Students/school", "format": ".1f" },
              { "field": "med_sps", "title": "National median", "format": ".1f" },
              { "field": "dev", "title": "Deviation", "format": ".1f" }
            ]
          }
        },

        {
          "mark": { "type": "rule", "strokeDash": [4,4] },
          "encoding": { "x": { "datum": 0, "type": "quantitative" } }
        },

        {
          "transform": [
            { "window": [{ "op": "rank", "as": "rank_pos" }], "sort": [{ "field": "dev", "order": "descending" }] },
            { "filter": "datum.rank_pos <= 3 && datum.dev > 0" }
          ],
          "mark": { "type": "text", "dy": -6, "align": "center", "baseline": "bottom", "fontWeight": "bold" },
          "encoding": {
            "y": { "field": "state_norm", "type": "nominal" },
            "x": { "field": "dev", "type": "quantitative" },
            "text": { "field": "state_norm" }
          }
        },

        {
          "transform": [
            { "window": [{ "op": "rank", "as": "rank_neg" }], "sort": [{ "field": "dev", "order": "ascending" }] },
            { "filter": "datum.rank_neg <= 3 && datum.dev < 0" }
          ],
          "mark": { "type": "text", "dy": -6, "align": "center", "baseline": "bottom", "fontWeight": "bold" },
          "encoding": {
            "y": { "field": "state_norm", "type": "nominal" },
            "x": { "field": "dev", "type": "quantitative" },
            "text": { "field": "state_norm" }
          }
        }
      ],
      "width": 500,
      "height": { "step": 20 }
    }
  ],

  "spacing": 35,
  "resolve": { "scale": { "x": "independent", "y": "independent", "color": "independent" } }
},




    {
      "title": { "text": "Basic Education stage gap on students per 1000 population within each state", "subtitle": "Filter by Selected Year" },
      "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/compiled_my_basiced_districtenrolment.csv" },
      "transform": [
        { "filter": "datum.year == YearSel" },
        { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" }
      ],
      "layer": [
        {
          "transform": [
            { "aggregate": [
                { "op": "min", "field": "students_per_1000_pop", "as": "xMin" },
                { "op": "max", "field": "students_per_1000_pop", "as": "xMax" }
              ],
              "groupby": ["state_norm"]
            }
          ],
          "mark": { "type": "rule" },
          "encoding": {
            "y": { "field": "state_norm", "type": "nominal",
                   "sort": {"field":"students_per_1000_pop","op":"max","order":"descending"} },
            "x": { "field": "xMin", "type": "quantitative", "title": "Students per 1000 population" },
            "x2": { "field": "xMax" }
          }
        },
        {
          "mark": { "type": "point", "filled": true, "size": 60 },
          "encoding": {
            "y": { "field": "state_norm", "type": "nominal",
                   "title": "States & Federal Territories",
                   "sort": {"field":"students_per_1000_pop","op":"max","order":"descending"} },
            "x": { "field": "students_per_1000_pop", "type": "quantitative" },
            "color": {
              "field": "stage", "type": "nominal", "title": "Stage",
              "scale": { "domain": ["primary","secondary"], "range": ["#4e79a7","#f28e2b"] }
            },
            "tooltip": [
              { "field": "state_norm", "title": "State" },
              { "field": "stage", "title": "Stage" },
              { "field": "students_per_1000_pop", "title": "Per 1000", "format": ".1f" }
            ]
          }
        },
        {
          "transform": [
            { "aggregate": [ { "op": "mean", "field": "students_per_1000_pop", "as": "rate" } ],
              "groupby": ["state_norm","stage"] },
            { "pivot": "stage", "value": "rate", "groupby": ["state_norm"] },
            { "calculate": "datum.secondary - datum.primary", "as": "diff" },
            { "calculate": "(datum.secondary + datum.primary)/2", "as": "midX" }
          ],
          "mark": { "type": "text", "fontWeight": "bold", "dy": -6 },
          "encoding": {
            "y": { "field": "state_norm", "type": "nominal",
                   "sort": {"field":"students_per_1000_pop","op":"max","order":"descending"} },
            "x": { "field": "midX", "type": "quantitative" },
            "text": { "field": "diff", "type": "quantitative", "format": "+,.1f" },
            "color": { "value": "#000" }
          }
        }
      ],
      "height": { "step": 20 },
      "width": 1200
    },




    {
      "title": {
            "text": "How basic education access changes over time by students per 1000 population",
            "subtitle": "Filter by States. Brush the bottom chart to zoom the top (2017â2022)"
        },
      "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/compiled_my_basiced_districtenrolment.csv" },

      
      "vconcat": [
        {
        "layer": [
            {
            "transform": [
                { "calculate": "Rekey", "as": "__rekey" },

                { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" },
                { "filter": "datum.state_norm === StateSel" },
                {
                "aggregate": [
                    { "op": "sum", "field": "students",   "as": "students" },
                    { "op": "sum", "field": "population", "as": "population" }
                ],
                "groupby": ["stage","year"]
                },
                { "calculate": "(datum.students / max(datum.population,1)) * 1000", "as": "students_per_1000_pop" },
                { "calculate": "toDate(datum.year + '-01-01')", "as": "year_dt" },
                
                { "filter": { "param": "brush" } },

                { "calculate": "StateSel", "as": "state_label" }
            ],
            "mark": { "type": "line" },
            "encoding": {
                "x": { "field": "year_dt", "type": "temporal", "title": "Year" },
                "y": { "field": "students_per_1000_pop", "type": "quantitative",
                    "title": "Students per 1000 population", "scale": { "domain": [0,800] } },
                "color": { "field": "stage", "type": "nominal", "title": "Stage",
                        "scale": { "domain": ["primary","secondary"], "range": ["#4e79a7","#f28e2b"] } },
                "order": { "field": "year_dt" }
            }
            },
            {
            "transform": [

                { "calculate": "Rekey", "as": "__rekey" },

                { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" },
                { "filter": "datum.state_norm === StateSel" },
                {
                "aggregate": [
                    { "op": "sum", "field": "students",   "as": "students" },
                    { "op": "sum", "field": "population", "as": "population" }
                ],
                "groupby": ["stage","year"]
                },
                { "calculate": "(datum.students / max(datum.population,1)) * 1000", "as": "students_per_1000_pop" },
                { "calculate": "toDate(datum.year + '-01-01')", "as": "year_dt" },
                { "filter": { "param": "brush" } },

                { "calculate": "StateSel", "as": "state_label" }
            ],
            "mark": { "type": "point", "filled": true },
            "encoding": {
                "x": { "field": "year_dt", "type": "temporal" },
                "y": { "field": "students_per_1000_pop", "type": "quantitative" },
                "color": { "field": "stage", "type": "nominal", "legend": null,
                        "scale": { "domain": ["primary","secondary"], "range": ["#4e79a7","#f28e2b"] } },
                
                "tooltip": [
                { "field": "state_label", "title": "State" },
                { "field": "stage", "title": "Stage" },
                { "field": "year",  "title": "Year" },
                { "field": "students_per_1000_pop", "title": "Per 1000", "format": ".1f" }
                ]
            }
            }
        ],
        "width": 1200,
        "height": 300
        },

        {
        "mark": { "type": "area", "opacity": 0.4 },
        "params": [ { "name": "brush", "select": { "type": "interval", "encodings": ["x"] } } ],
        "transform": [
            { "calculate": "Rekey", "as": "__rekey" },

            { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" },
            { "filter": "datum.state_norm === StateSel" },
            {
            "aggregate": [
                { "op": "sum", "field": "students",   "as": "students" },
                { "op": "sum", "field": "population", "as": "population" }
            ],
            "groupby": ["stage","year"]
            },
            { "calculate": "(datum.students / max(datum.population,1)) * 1000", "as": "students_per_1000_pop" },
            { "calculate": "toDate(datum.year + '-01-01')", "as": "year_dt" }
        ],
        "encoding": {
            "x": { "field": "year_dt", "type": "temporal", "axis": { "title": null } },
            "y": { "field": "students_per_1000_pop", "type": "quantitative",
                "axis": { "tickCount": 3, "grid": false, "title": null } },
            "color": { "field": "stage", "type": "nominal", "legend": null,
                    "scale": { "domain": ["primary","secondary"], "range": ["#4e79a7","#f28e2b"] } }
        },
        "width": 1200,
        "height": 70
        }
    ]
    },




    {
      "title": { "text": "Population vs Students Comparison" },
      "data": { "url": "https://yuankahmun.github.io/FIT3179A2/data/compiled_my_basiced_districtenrolment.csv" },
      "transform": [
        { "filter": "datum.stage == StageSel && datum.year == YearSel" },
        { "calculate": "indexof(datum.state,'W.p. ')==0 ? substring(datum.state,5) : datum.state", "as": "state_norm" },
        {
          "aggregate": [
            { "op": "sum", "field": "population", "as": "sum_population" },
            { "op": "sum", "field": "students", "as": "sum_students" }
          ],
          "groupby": ["state_norm"]
        },
        { "calculate": "datum.sum_students / max(datum.sum_population, 1)", "as": "stud_pop_ratio" },
        { "fold": ["sum_population", "sum_students"], "as": ["metric_key", "count"] },
        { "calculate": "datum.metric_key == 'sum_population' ? 'Population' : 'Students'", "as": "metric_label" },
        { "joinaggregate": [{ "op": "max", "field": "count", "as": "max_count" }], "groupby": ["metric_label"] },
        { "calculate": "datum.count == datum.max_count", "as": "is_max" }
      ],
      "columns": 2,
      "facet": {
        "column": {
          "field": "metric_label", "type": "nominal", "title": null, "sort": ["Population","Students"],
          "header": { "labelExpr": "datum.label == 'Population' ? 'Population (total)' : 'Students (total)'" }
        }
      },
      "spec": {
        "layer": [
          {
            "mark": { "type": "bar" },
            "encoding": {
              "y": { "field": "state_norm", "type": "nominal",
                     "sort": { "field": "stud_pop_ratio", "order": "descending" },
                     "title": "States & Federal Territories", "axis": { "labelLimit": 180 } },
              "x": { "field": "count", "type": "quantitative", "title": "Total", "axis": { "format": "s" } },
              "color": { "field": "metric_label", "type": "nominal", "legend": null,
                "scale": { "domain": ["Population","Students"], "range": ["#4e79a7","#f28e2b"] } },
              "opacity": { "condition": { "test": "datum.is_max", "value": 1 }, "value": 0.3 },
              "stroke": { "value": "black" },
              "strokeWidth": { "condition": { "test": "datum.is_max", "value": 1.5 }, "value": 0 },
              "tooltip": [
                { "field": "state_norm", "title": "State" },
                { "field": "sum_population", "title": "Population (total)", "format": "," },
                { "field": "sum_students", "title": "Students (total)", "format": "," },
                { "field": "stud_pop_ratio", "title": "Students per person", "format": ".3f" }
              ]
            }
          },
          {
            "transform": [{ "filter": "datum.is_max" }],
            "mark": { "type": "text", "dx": 6, "align": "left", "fontWeight": "bold" },
            "encoding": {
              "y": { "field": "state_norm", "type": "nominal" },
              "x": { "field": "count", "type": "quantitative" },
              "text": { "field": "count", "type": "quantitative", "format": "s" },
              "color": { "value": "#333" }
            }
          }
        ],
        "width": 550,
        "height": { "step": 20 }
      },
      "resolve": { "scale": { "x": "independent" } }
    }
  ],

  "spacing": 100,

  "resolve": { "scale": { "x": "independent", "y": "independent", "color": "independent" } },

  "config": {
    "font": "PT Serif",
    "title": { "font": "PT Serif", "fontSize": 20, "fontWeight": 700,
      "subtitleFont": "PT Serif", "subtitleFontSize": 16,   "subtitlePadding": 16,
      "offset": 50},
    "axis":  { "labelFont": "DM Sans", "titleFont": "PT Serif", "titleFontWeight": 700 },
    "legend":{ "labelFont": "DM Sans", "titleFont": "PT Serif", "titleFontWeight": 700 },
    "header":{ "labelFont": "DM Sans", "titleFont": "PT Serif", "titleFontWeight": 700 },
    "view":  { "stroke": null }
  }
}
